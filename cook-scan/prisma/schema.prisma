// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ユーザーテーブル（Supabase Auth用）
model User {
  id        String   @id @default(uuid())
  authId    String   @unique @map("auth_id")
  email     String   @unique
  name      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  recipes              Recipe[]
  tagCategories        TagCategory[]
  tags                 Tag[]
  ocrProcessingHistory OcrProcessingHistory[]
  recipeVersions       RecipeVersion[]

  @@map("users")
}

// レシピテーブル
model Recipe {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String
  imageUrl  String?  @map("image_url")
  memo      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user                 User                  @relation(fields: [userId], references: [id])
  ingredients          Ingredient[]
  steps                Step[]
  recipeTags           RecipeTag[]
  ocrProcessingHistory OcrProcessingHistory?
  recipeVersions       RecipeVersion[]
  sourceInfo           SourceInfo[]

  // 自己結合(多対多)
  usedInRecipes RecipeRelation[] @relation("ParentRecipe")
  usesRecipes   RecipeRelation[] @relation("ChildRecipe")

  @@map("recipes")
}

model RecipeRelation {
  id             String   @id @default(uuid())
  parentRecipeId String   @map("parent_recipe_id")
  childRecipeId  String   @map("child_recipe_id")
  quantity       String? // 例: "大さじ2"
  notes          String? // メモ
  createdAt      DateTime @default(now()) @map("created_at")

  parentRecipe Recipe @relation("ParentRecipe", fields: [parentRecipeId], references: [id], onDelete: Cascade)
  childRecipe  Recipe @relation("ChildRecipe", fields: [childRecipeId], references: [id], onDelete: Cascade)

  @@unique([parentRecipeId, childRecipeId])
  @@map("recipe_relations")
}

// 材料テーブル
model Ingredient {
  id        String   @id @default(uuid())
  recipeId  String   @map("recipe_id")
  name      String
  unit      String?
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  recipe Recipe @relation(fields: [recipeId], references: [id])

  @@map("ingredients")
}

// 調理手順テーブル
model Step {
  id           String   @id @default(uuid())
  recipeId     String   @map("recipe_id")
  orderIndex   Int      @map("order_index")
  instruction  String
  timerSeconds Int?     @map("timer_seconds")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  recipe Recipe @relation(fields: [recipeId], references: [id])

  @@map("steps")
}

// タグカテゴリテーブル
model TagCategory {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  name        String
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])
  tags Tag[]

  @@map("tag_categories")
}

// タグテーブル
model Tag {
  id          String   @id @default(uuid())
  categoryId  String   @map("category_id")
  userId      String?  @map("user_id")
  name        String
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  category   TagCategory @relation(fields: [categoryId], references: [id])
  recipeTags RecipeTag[]
  user       User?       @relation(fields: [userId], references: [id])

  @@map("tags")
}

// レシピ・タグ中間テーブル
model RecipeTag {
  recipeId  String   @map("recipe_id")
  tagId     String   @map("tag_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([recipeId, tagId])
  @@map("recipe_tags")
}

// OCR処理履歴テーブル
model OcrProcessingHistory {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  recipeId       String   @unique @map("recipe_id")
  ocrResult      Json     @map("ocr_result")
  structuredData Json     @map("structured_data")
  status         String
  processedAt    DateTime @map("processed_at")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  user   User   @relation(fields: [userId], references: [id])
  recipe Recipe @relation(fields: [recipeId], references: [id])

  @@map("ocr_processing_history")
}

// レシピ版管理テーブル（Could要件）
model RecipeVersion {
  id            String   @id @default(uuid())
  recipeId      String   @map("recipe_id")
  versionNumber Int      @map("version_number")
  snapshot      Json
  changeNote    String?  @map("change_note")
  createdBy     String   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  recipe Recipe @relation(fields: [recipeId], references: [id])
  user   User   @relation(fields: [createdBy], references: [id])

  @@map("recipe_versions")
}

// ソース情報テーブル
model SourceInfo {
  id         String   @id @default(uuid())
  recipeId   String   @map("recipe_id")
  sourceType String?
  sourceName String?
  sourceUrl  String?
  pageNumber String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  recipe Recipe @relation(fields: [recipeId], references: [id])

  @@map("source_infos")
}
